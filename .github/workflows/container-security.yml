name: Container Security & Build
# Repository: https://github.com/dagiim/webops
# Owner: Douglas Mutethia (Eleso Solutions)
# WebOps: Self-hosted VPS hosting platform for deploying and managing web applications

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'control-panel/**'
      - 'cli/**'
      - 'Dockerfile*'
      - 'docker-compose*'
      - '.dockerignore'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'control-panel/**'
      - 'cli/**'
      - 'Dockerfile*'
      - 'docker-compose*'
      - '.dockerignore'
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Build & Test Docker Images
    runs-on: ubuntu-latest

    strategy:
      matrix:
        component: [control-panel, cli]
        include:
          - component: control-panel
            context: .
            dockerfile: Dockerfile
          - component: cli
            context: ./cli
            dockerfile: Dockerfile

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.component }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.context }}
        file: ${{ matrix.dockerfile }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: build

    strategy:
      matrix:
        component: [control-panel, cli]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.component }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-${{ matrix.component }}-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-${{ matrix.component }}-results.sarif'

    - name: Run Docker Scout
      uses: docker/scout-action@v1
      with:
        command: cves
        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.component }}:${{ github.sha }}
        format: sarif
        output: 'scout-${{ matrix.component }}-results.sarif'

    - name: Upload Docker Scout results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'scout-${{ matrix.component }}-results.sarif'

  sast-scan:
    name: SAST (Static Application Security Testing)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python
        queries: security-extended,security-and-quality

    - name: Autobuild
      uses: github/codeql-action/autobuild@v3

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:python"

    - name: Run Semgrep SAST
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/python
          p/django
          p/click
          p/docker
        generateSarif: "1"

    - name: Upload Semgrep results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: semgrep.sarif

  dast-scan:
    name: DAST (Dynamic Application Security Testing)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[dast]')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        cd control-panel
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install selenium webtest

    - name: Create test environment
      run: |
        cd control-panel
        cat > .env << EOF
        DEBUG=True
        SECRET_KEY=test-secret-key-for-dast
        DATABASE_URL=sqlite:///test.db
        CELERY_BROKER_URL=redis://localhost:6379/0
        ALLOWED_HOSTS=*
        ENCRYPTION_KEY=$(python -c 'from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())')
        EOF
        python manage.py migrate --noinput
        python manage.py collectstatic --noinput

    - name: Start application
      run: |
        cd control-panel
        python manage.py runserver 0.0.0.0:8000 &
        sleep 10

    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: 'http://localhost:8000'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_ENABLE_COMMENTS: false

    - name: Run TruffleHog OSS
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.before }}
        head: ${{ github.sha }}
        extra_args: --debug --only-verified

  license-scan:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install license checker
      run: |
        pip install pip-licenses licensecheck
        pip install -r control-panel/requirements.txt -r cli/requirements.txt

    - name: Check licenses
      run: |
        echo "=== Control Panel Licenses ===" > license-report.md
        cd control-panel
        pip-licenses --format=markdown --with-license-file --output-file=../control-panel-licenses.md || true
        cat ../control-panel-licenses.md >> ../license-report.md
        
        echo "" >> ../license-report.md
        echo "=== CLI Licenses ===" >> ../license-report.md
        cd ../cli
        pip-licenses --format=markdown --with-license-file --output-file=../cli-licenses.md || true
        cat ../cli-licenses.md >> ../license-report.md

    - name: Check for problematic licenses
      run: |
        cd control-panel
        pip-licenses --format=json --output-file=../control-panel-licenses.json || true
        cd ../cli  
        pip-licenses --format=json --output-file=../cli-licenses.json || true
        
        # Check for GPL licenses (may not be suitable for commercial use)
        if grep -i "gpl" control-panel-licenses.json cli-licenses.json; then
          echo "⚠ Warning: GPL licenses detected"
        fi

    - name: Upload license report
      uses: actions/upload-artifact@v4
      with:
        name: license-report
        path: license-report.md

  sbom-generation:
    name: Software Bill of Materials
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install SBOM tools
      run: |
        pip install cyclonedx-bom pip-licenses
        pip install -r control-panel/requirements.txt -r cli/requirements.txt

    - name: Generate SBOM for control-panel
      run: |
        cd control-panel
        cyclonedx-py scan --format json --output webops-control-panel-sbom.json
        cyclonedx-py scan --format xml --output webops-control-panel-sbom.xml

    - name: Generate SBOM for CLI
      run: |
        cd cli
        cyclonedx-py scan --format json --output webops-cli-sbom.json
        cyclonedx-py scan --format xml --output webops-cli-sbom.xml

    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sbom-artifacts
        path: |
          control-panel/webops-control-panel-sbom.*
          cli/webops-cli-sbom.*

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-scan, sast-scan, dependency-review, secrets-scan, license-scan]
    if: always() && (github.event_name == 'schedule' || contains(github.event.head_commit.message, '[security-report]'))

    steps:
    - name: Create Security Report
      run: |
        echo "# WebOps Security Report - $(date)" > security-summary.md
        echo "" >> security-summary.md
        echo "## Scan Results Summary" >> security-summary.md
        echo "" >> security-summary.md
        
        echo "### Container Security" >> security-summary.md
        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "✅ Container security scans completed" >> security-summary.md
        else
          echo "❌ Container security scans failed" >> security-summary.md
        fi
        
        echo "### SAST Analysis" >> security-summary.md
        if [ "${{ needs.sast-scan.result }}" == "success" ]; then
          echo "✅ SAST analysis completed" >> security-summary.md
        else
          echo "❌ SAST analysis failed" >> security-summary.md
        fi
        
        echo "### Dependency Review" >> security-summary.md
        if [ "${{ needs.dependency-review.result }}" == "success" ]; then
          echo "✅ Dependency review passed" >> security-summary.md
        elif [ "${{ needs.dependency-review.result }}" == "skipped" ]; then
          echo "⏭️ Dependency review skipped (not a PR)" >> security-summary.md
        else
          echo "❌ Dependency review failed" >> security-summary.md
        fi
        
        echo "### Secrets Detection" >> security-summary.md
        if [ "${{ needs.secrets-scan.result }}" == "success" ]; then
          echo "✅ No secrets detected" >> security-summary.md
        else
          echo "⚠️ Secrets scan completed with warnings" >> security-summary.md
        fi
        
        echo "### License Compliance" >> security-summary.md
        if [ "${{ needs.license-scan.result }}" == "success" ]; then
          echo "✅ License compliance check completed" >> security-summary.md
        else
          echo "❌ License compliance check failed" >> security-summary.md
        fi
        
        cat security-summary.md

    - name: Upload security summary
      uses: actions/upload-artifact@v4
      with:
        name: security-summary
        path: security-summary.md