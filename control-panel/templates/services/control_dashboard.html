{% extends 'base.html' %}

{% block title %}Service Control - WebOps{% endblock %}
{% block header_title %}Service Control{% endblock %}

{% block content %}
<div class="webops-page-header">
    <div>
        <h2 class="webops-page-title">Service Control Dashboard</h2>
        <p class="webops-text-muted">Manage and monitor all deployment services</p>
    </div>
    <div class="webops-flex webops-gap-sm">
        <button onclick="location.href='{% url 'monitoring:restart_policy_list' %}'" class="webops-btn webops-btn-secondary">
            <span class="material-icons">settings</span>
            Restart Policies
        </button>
        <button onclick="location.href='{% url 'monitoring:configuration_list' %}'" class="webops-btn webops-btn-secondary">
            <span class="material-icons">tune</span>
            Configuration
        </button>
    </div>
</div>

<!-- System Health Overview -->
<div class="webops-stats-grid webops-mb-lg">
    <div class="webops-stat-card">
        <div class="webops-stat-icon" style="background: rgba({% if system_health.healthy %}0, 255, 136{% else %}255, 68, 68{% endif %}, 0.1); color: var(--webops-color-{% if system_health.healthy %}success{% else %}error{% endif %});">
            <span class="material-icons">{{ system_health.healthy|yesno:"check_circle,cancel" }}</span>
        </div>
        <div class="webops-stat-value">{{ system_health.healthy|yesno:"Healthy,Unhealthy" }}</div>
        <div class="webops-stat-label">System Status</div>
    </div>

    <div class="webops-stat-card">
        <div class="webops-stat-icon" style="background: rgba(0, 170, 255, 0.1); color: var(--webops-color-info);">
            <span class="material-icons">dns</span>
        </div>
        <div class="webops-stat-value">{{ system_health.deployments.healthy }} / {{ system_health.deployments.total_checked }}</div>
        <div class="webops-stat-label">Services Healthy</div>
    </div>

    <div class="webops-stat-card">
        <div class="webops-stat-icon" style="background: rgba(255, 170, 0, 0.1); color: var(--webops-color-warning);">
            <span class="material-icons">{{ celery_status.healthy|yesno:"check_circle,warning" }}</span>
        </div>
        <div class="webops-stat-value">{{ celery_status.worker_count }}</div>
        <div class="webops-stat-label">Celery Workers</div>
        <div class="webops-text-xs webops-text-secondary webops-mt-xs">
            Beat: {{ celery_status.beat_running|yesno:"Running,Stopped" }}
        </div>
    </div>

    <div class="webops-stat-card">
        <div class="webops-stat-icon" style="background: rgba(255, 68, 68, 0.1); color: var(--webops-color-error);">
            <span class="material-icons">notifications_active</span>
        </div>
        <div class="webops-stat-value">{{ system_health.alerts.total }}</div>
        <div class="webops-stat-label">Active Alerts</div>
        <div class="webops-text-xs webops-text-secondary webops-mt-xs">
            {{ system_health.alerts.critical }} critical
        </div>
    </div>
</div>

<!-- Bulk Actions -->
<div class="webops-card webops-mb-lg">
    <div class="webops-card-header">
        <h3 class="webops-h3">Bulk Operations</h3>
        <div class="webops-text-sm webops-text-secondary">Apply actions to all services</div>
    </div>
    <div class="webops-card-body">
        <div class="webops-flex webops-gap-md webops-flex-wrap">
            <form method="post" action="{% url 'monitoring:bulk_start_services' %}" onsubmit="return confirm('Start all stopped services?');" class="inline-form">
                {% csrf_token %}
                <button type="submit" class="webops-btn webops-btn-success">
                    <span class="material-icons">play_arrow</span>
                    Start All
                </button>
            </form>

            <form method="post" action="{% url 'monitoring:bulk_stop_services' %}" onsubmit="return confirm('Stop all running services? This will cause downtime.');" class="inline-form">
                {% csrf_token %}
                <button type="submit" class="webops-btn webops-btn-danger">
                    <span class="material-icons">stop</span>
                    Stop All
                </button>
            </form>

            <form method="post" action="{% url 'monitoring:bulk_restart_services' %}" onsubmit="return confirm('Restart all running services? This may cause brief downtime.');" class="inline-form">
                {% csrf_token %}
                <button type="submit" class="webops-btn webops-btn-warning">
                    <span class="material-icons">restart_alt</span>
                    Restart All
                </button>
            </form>

            <a href="{% url 'monitoring:background_management' %}" class="webops-btn webops-btn-info">
                <span class="material-icons">settings_applications</span>
                Manage Background Processes
            </a>
        </div>
    </div>
</div>

<!-- Service List -->
<div class="webops-card">
    <div class="webops-card-header">
        <h3 class="webops-h3">Deployment Services</h3>
        <div class="webops-text-sm webops-text-secondary">
            {{ service_statuses|length }} total services
        </div>
    </div>

    {% if service_statuses %}
    <div class="webops-table-responsive">
        <table class="webops-table">
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Status</th>
                    <th>Type</th>
                    <th>SSL</th>
                    <th>PID</th>
                    <th>CPU</th>
                    <th>Memory</th>
                    <th>Uptime</th>
                    <th>Policy</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in service_statuses %}
                <tr id="service-{{ item.deployment.id }}">
                    <td>
                        <div class="webops-font-semibold">{{ item.deployment.name }}</div>
                        {% if item.deployment.domain %}
                        <div class="webops-text-xs webops-text-secondary">{{ item.deployment.domain }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.status.status == 'running' %}
                            <span class="webops-badge webops-badge-success">
                                <span class="material-icons webops-icon-xs">check_circle</span>
                                Running
                            </span>
                        {% elif item.status.status == 'stopped' %}
                            <span class="webops-badge webops-badge-info">
                                <span class="material-icons webops-icon-xs">stop_circle</span>
                                Stopped
                            </span>
                        {% elif item.status.status == 'failed' %}
                            <span class="webops-badge webops-badge-danger">
                                <span class="material-icons webops-icon-xs">error</span>
                                Failed
                            </span>
                        {% else %}
                            <span class="webops-badge webops-badge-warning">
                                {{ item.status.get_status_display }}
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="webops-badge webops-badge-secondary">
                            {{ item.deployment.get_project_type_display }}
                        </span>
                    </td>
                    <td>
                        <div class="ssl-status" data-deployment-id="{{ item.deployment.id }}">
                            <span class="webops-badge webops-badge-secondary">
                                <span class="material-icons webops-icon-xs">lock_open</span>
                                Checking...
                            </span>
                        </div>
                    </td>
                    <td><code>{{ item.status.pid|default:"—" }}</code></td>
                    <td>
                        <span class="{% if item.status.cpu_percent > 80 %}webops-text-error{% elif item.status.cpu_percent > 60 %}webops-text-warning{% endif %}">
                            {{ item.status.cpu_percent|floatformat:1 }}%
                        </span>
                    </td>
                    <td>
                        <span class="{% if item.status.memory_mb > 1000 %}webops-text-warning{% endif %}">
                            {{ item.status.memory_mb|floatformat:0 }} MB
                        </span>
                    </td>
                    <td>
                        {% if item.status.uptime_seconds %}
                            {% widthratio item.status.uptime_seconds 3600 1 %}h {% widthratio item.status.uptime_seconds 60 1|add:"-60"|add:"-1" %}m
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        {% if item.policy %}
                            <a href="{% url 'monitoring:restart_policy_edit' item.deployment.id %}" class="webops-link">
                                <span class="webops-badge webops-badge-{{ item.policy.enabled|yesno:'primary,secondary' }}">
                                    {{ item.policy.get_policy_type_display }}
                                </span>
                            </a>
                        {% else %}
                            <a href="{% url 'monitoring:restart_policy_edit' item.deployment.id %}" class="webops-link webops-text-muted">
                                <span class="material-icons webops-icon-sm">add</span>
                                Add
                            </a>
                        {% endif %}
                    </td>
                    <td>
                        <div class="webops-btn-group">
                            {% if item.status.status != 'running' %}
                            <form method="post" action="{% url 'monitoring:start_service' item.deployment.id %}" class="inline-form">
                                {% csrf_token %}
                                <button type="submit" class="webops-btn webops-btn-xs webops-btn-success" title="Start">
                                    <span class="material-icons">play_arrow</span>
                                </button>
                            </form>
                            {% endif %}

                            {% if item.status.status == 'running' %}
                            <form method="post" action="{% url 'monitoring:restart_service' item.deployment.id %}" class="inline-form">
                                {% csrf_token %}
                                <button type="submit" class="webops-btn webops-btn-xs webops-btn-warning" title="Restart">
                                    <span class="material-icons">restart_alt</span>
                                </button>
                            </form>

                            <form method="post" action="{% url 'monitoring:stop_service' item.deployment.id %}" class="inline-form" onsubmit="return confirm('Stop {{ item.deployment.name }}?');">
                                {% csrf_token %}
                                <button type="submit" class="webops-btn webops-btn-xs webops-btn-danger" title="Stop">
                                    <span class="material-icons">stop</span>
                                </button>
                            </form>
                            {% endif %}

                            <a href="{% url 'monitoring:service_status_detail' item.deployment.id %}" class="webops-btn webops-btn-xs webops-btn-info" title="Details">
                                <span class="material-icons">info</span>
                            </a>
                            
                            <button type="button" class="webops-btn webops-btn-xs webops-btn-secondary ssl-config-btn" 
                                    data-deployment-id="{{ item.deployment.id }}" 
                                    data-deployment-name="{{ item.deployment.name }}"
                                    title="SSL Configuration">
                                <span class="material-icons">lock</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="webops-empty-state">
        <span class="material-icons webops-empty-state-icon" style="font-size: 64px; color: var(--webops-color-text-tertiary); opacity: 0.3;">rocket_launch</span>
        <h3 class="webops-empty-state-title">No deployments yet</h3>
        <p class="webops-empty-state-description">Deploy your first application to start managing services</p>
        <a href="{% url 'deployments:deployment_create' %}" class="webops-btn webops-btn-primary">
            <span class="material-icons">add</span>
            Create Deployment
        </a>
    </div>
    {% endif %}
</div>

<style>
.inline-form {
    display: inline-block;
    margin: 0;
}

.webops-btn-group {
    display: flex;
    gap: 0.25rem;
}

.webops-icon-xs {
    font-size: 14px;
}

.webops-icon-sm {
    font-size: 16px;
}
</style>

<script>
// Auto-refresh service status
let refreshInterval;

function refreshServiceStatus() {
    fetch('{% url 'monitoring:api_system_health' %}')
        .then(response => response.json())
        .then(data => {
            // Update without full page reload if needed
            console.log('System health updated:', data);
        })
        .catch(error => console.error('Error refreshing status:', error));
}

// Refresh every 30 seconds
document.addEventListener('DOMContentLoaded', () => {
    refreshInterval = setInterval(refreshServiceStatus, 30000);
});

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});

// SSL Configuration Modal
const sslModal = document.createElement('div');
sslModal.id = 'ssl-config-modal';
sslModal.className = 'webops-modal';
sslModal.innerHTML = `
    <div class="webops-modal-content" style="max-width: 600px;">
        <div class="webops-modal-header">
            <h3 class="webops-modal-title">SSL Configuration</h3>
            <button type="button" class="webops-modal-close" onclick="closeSSLModal()">&times;</button>
        </div>
        <div class="webops-modal-body">
            <div id="ssl-status-info" class="webops-alert webops-alert-info" style="margin-bottom: 1rem;">
                <div class="webops-alert-content">
                    <span class="material-icons webops-alert-icon">info</span>
                    <div class="webops-alert-text">
                        <div class="webops-alert-title">Loading SSL status...</div>
                        <div class="webops-alert-description">Please wait while we check the SSL configuration.</div>
                    </div>
                </div>
            </div>
            
            <form id="ssl-config-form" enctype="multipart/form-data">
                <input type="hidden" id="ssl-deployment-id" name="deployment_id">
                
                <div class="webops-form-group">
                    <label class="webops-label">SSL Status</label>
                    <div class="webops-flex webops-gap-md webops-align-center">
                        <label class="webops-switch">
                            <input type="checkbox" id="ssl-enabled" name="enabled">
                            <span class="webops-switch-slider"></span>
                        </label>
                        <span id="ssl-status-text">Disabled</span>
                    </div>
                </div>
                
                <div class="webops-form-group">
                    <label class="webops-label" for="ssl-domain">Domain Name</label>
                    <input type="text" id="ssl-domain" name="domain" class="webops-input" placeholder="example.com">
                </div>
                
                <div class="webops-form-group">
                    <label class="webops-label" for="ssl-certificate-type">Certificate Type</label>
                    <select id="ssl-certificate-type" name="certificate_type" class="webops-select">
                        <option value="self_signed">Self-Signed Certificate</option>
                        <option value="lets_encrypt">Let's Encrypt (Not Available)</option>
                        <option value="custom">Custom Certificate</option>
                    </select>
                </div>
                
                <div id="custom-certificate-fields" style="display: none;">
                    <div class="webops-form-group">
                        <label class="webops-label" for="ssl-certificate">Certificate File (.pem)</label>
                        <input type="file" id="ssl-certificate" name="certificate" class="webops-input" accept=".pem,.crt,.cert">
                    </div>
                    
                    <div class="webops-form-group">
                        <label class="webops-label" for="ssl-private-key">Private Key File (.pem)</label>
                        <input type="file" id="ssl-private-key" name="private_key" class="webops-input" accept=".pem,.key">
                    </div>
                </div>
                
                <div class="webops-form-group">
                    <label class="webops-label" for="ssl-encryption-protocol">Encryption Protocol</label>
                    <select id="ssl-encryption-protocol" name="encryption_protocol" class="webops-select">
                        <option value="TLSv1.3">TLS 1.3 (Recommended)</option>
                        <option value="TLSv1.2">TLS 1.2</option>
                    </select>
                </div>
                
                <div class="webops-form-group">
                    <label class="webops-switch">
                        <input type="checkbox" id="ssl-hsts-enabled" name="hsts_enabled" checked>
                        <span class="webops-switch-slider"></span>
                    </label>
                    <span>Enable HSTS (HTTP Strict Transport Security)</span>
                </div>
            </form>
        </div>
        <div class="webops-modal-footer">
            <button type="button" class="webops-btn webops-btn-secondary" onclick="closeSSLModal()">Cancel</button>
            <button type="button" class="webops-btn webops-btn-primary" onclick="saveSSLConfig()">Save Configuration</button>
        </div>
    </div>
`;

document.body.appendChild(sslModal);

// SSL Status Functions
function updateSSLStatus() {
    const sslStatusElements = document.querySelectorAll('.ssl-status');
    
    sslStatusElements.forEach(element => {
        const deploymentId = element.dataset.deploymentId;
        
        fetch(`/monitoring/ssl/status/${deploymentId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let statusHtml = '';
                    
                    if (data.enabled && data.is_valid) {
                        statusHtml = `
                            <span class="webops-badge webops-badge-success">
                                <span class="material-icons webops-icon-xs">lock</span>
                                SSL Active
                            </span>
                        `;
                    } else if (data.enabled && !data.is_valid) {
                        statusHtml = `
                            <span class="webops-badge webops-badge-warning">
                                <span class="material-icons webops-icon-xs">warning</span>
                                Invalid Cert
                            </span>
                        `;
                    } else if (data.configured) {
                        statusHtml = `
                            <span class="webops-badge webops-badge-secondary">
                                <span class="material-icons webops-icon-xs">lock_open</span>
                                SSL Disabled
                            </span>
                        `;
                    } else {
                        statusHtml = `
                            <span class="webops-badge webops-badge-secondary">
                                <span class="material-icons webops-icon-xs">lock_open</span>
                                Not Configured
                            </span>
                        `;
                    }
                    
                    element.innerHTML = statusHtml;
                } else {
                    element.innerHTML = `
                        <span class="webops-badge webops-badge-error">
                            <span class="material-icons webops-icon-xs">error</span>
                            Error
                        </span>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching SSL status:', error);
                element.innerHTML = `
                    <span class="webops-badge webops-badge-error">
                        <span class="material-icons webops-icon-xs">error</span>
                        Error
                    </span>
                `;
            });
    });
}

// SSL Configuration Modal Functions
function openSSLModal(deploymentId, deploymentName) {
    document.getElementById('ssl-deployment-id').value = deploymentId;
    document.querySelector('.webops-modal-title').textContent = `SSL Configuration - ${deploymentName}`;
    
    // Fetch current SSL configuration
    fetch(`/monitoring/ssl/status/${deploymentId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.configured) {
                document.getElementById('ssl-enabled').checked = data.enabled;
                document.getElementById('ssl-domain').value = data.domain || '';
                document.getElementById('ssl-certificate-type').value = data.certificate_type || 'self_signed';
                document.getElementById('ssl-encryption-protocol').value = data.encryption_protocol || 'TLSv1.3';
                document.getElementById('ssl-hsts-enabled').checked = data.hsts_enabled || false;
                
                updateSSLStatusText();
                updateCertificateFields();
                
                let statusInfo = '';
                if (data.is_valid) {
                    statusInfo = `
                        <div class="webops-alert webops-alert-success">
                            <div class="webops-alert-content">
                                <span class="material-icons webops-alert-icon">check_circle</span>
                                <div class="webops-alert-text">
                                    <div class="webops-alert-title">SSL Certificate Valid</div>
                                    <div class="webops-alert-description">Valid until ${data.valid_until ? new Date(data.valid_until).toLocaleDateString() : 'Unknown'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    statusInfo = `
                        <div class="webops-alert webops-alert-warning">
                            <div class="webops-alert-content">
                                <span class="material-icons webops-alert-icon">warning</span>
                                <div class="webops-alert-text">
                                    <div class="webops-alert-title">Certificate Invalid</div>
                                    <div class="webops-alert-description">${data.message}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                document.getElementById('ssl-status-info').innerHTML = statusInfo;
            } else {
                document.getElementById('ssl-enabled').checked = false;
                document.getElementById('ssl-domain').value = '';
                document.getElementById('ssl-certificate-type').value = 'self_signed';
                document.getElementById('ssl-encryption-protocol').value = 'TLSv1.3';
                document.getElementById('ssl-hsts-enabled').checked = true;
                
                updateSSLStatusText();
                updateCertificateFields();
                
                document.getElementById('ssl-status-info').innerHTML = `
                    <div class="webops-alert webops-alert-info">
                        <div class="webops-alert-content">
                            <span class="material-icons webops-alert-icon">info</span>
                            <div class="webops-alert-text">
                                <div class="webops-alert-title">SSL Not Configured</div>
                                <div class="webops-alert-description">Configure SSL settings for this deployment.</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching SSL configuration:', error);
            document.getElementById('ssl-status-info').innerHTML = `
                <div class="webops-alert webops-alert-error">
                    <div class="webops-alert-content">
                        <span class="material-icons webops-alert-icon">error</span>
                        <div class="webops-alert-text">
                            <div class="webops-alert-title">Error Loading Configuration</div>
                            <div class="webops-alert-description">Failed to load SSL configuration.</div>
                        </div>
                    </div>
                </div>
            `;
        });
    
    sslModal.style.display = 'flex';
}

function closeSSLModal() {
    sslModal.style.display = 'none';
    document.getElementById('ssl-config-form').reset();
}

function updateSSLStatusText() {
    const enabled = document.getElementById('ssl-enabled').checked;
    document.getElementById('ssl-status-text').textContent = enabled ? 'Enabled' : 'Disabled';
}

function updateCertificateFields() {
    const certType = document.getElementById('ssl-certificate-type').value;
    const customFields = document.getElementById('custom-certificate-fields');
    
    if (certType === 'custom') {
        customFields.style.display = 'block';
    } else {
        customFields.style.display = 'none';
    }
}

function saveSSLConfig() {
    const formData = new FormData(document.getElementById('ssl-config-form'));
    const deploymentId = document.getElementById('ssl-deployment-id').value;
    
    // Show loading state
    const saveButton = document.querySelector('.webops-modal-footer .webops-btn-primary');
    saveButton.disabled = true;
    saveButton.textContent = 'Saving...';
    
    fetch(`/monitoring/ssl/configure/${deploymentId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            document.getElementById('ssl-status-info').innerHTML = `
                <div class="webops-alert webops-alert-success">
                    <div class="webops-alert-content">
                        <span class="material-icons webops-alert-icon">check_circle</span>
                        <div class="webops-alert-text">
                            <div class="webops-alert-title">Configuration Saved</div>
                            <div class="webops-alert-description">${data.message}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Update SSL status display
            setTimeout(() => {
                closeSSLModal();
                updateSSLStatus();
            }, 1500);
        } else {
            // Show error message
            document.getElementById('ssl-status-info').innerHTML = `
                <div class="webops-alert webops-alert-error">
                    <div class="webops-alert-content">
                        <span class="material-icons webops-alert-icon">error</span>
                        <div class="webops-alert-text">
                            <div class="webops-alert-title">Configuration Failed</div>
                            <div class="webops-alert-description">${data.message || 'Unknown error occurred'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error saving SSL configuration:', error);
        document.getElementById('ssl-status-info').innerHTML = `
            <div class="webops-alert webops-alert-error">
                <div class="webops-alert-content">
                    <span class="material-icons webops-alert-icon">error</span>
                    <div class="webops-alert-text">
                        <div class="webops-alert-title">Network Error</div>
                        <div class="webops-alert-description">Failed to save configuration. Please try again.</div>
                    </div>
                </div>
            </div>
        `;
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.textContent = 'Save Configuration';
    });
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    // SSL configuration buttons
    document.querySelectorAll('.ssl-config-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const deploymentId = e.target.closest('button').dataset.deploymentId;
            const deploymentName = e.target.closest('button').dataset.deploymentName;
            openSSLModal(deploymentId, deploymentName);
        });
    });
    
    // SSL status toggle
    document.getElementById('ssl-enabled').addEventListener('change', updateSSLStatusText);
    
    // Certificate type change
    document.getElementById('ssl-certificate-type').addEventListener('change', updateCertificateFields);
    
    // Initial SSL status update
    updateSSLStatus();
    
    // Refresh SSL status periodically
    setInterval(updateSSLStatus, 60000); // Every minute
});

// Close modal when clicking outside
sslModal.addEventListener('click', (e) => {
    if (e.target === sslModal) {
        closeSSLModal();
    }
});
</script>
{% endblock %}
