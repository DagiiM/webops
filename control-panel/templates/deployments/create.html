{% extends 'base.html' %}

{% block title %}New Deployment - WebOps{% endblock %}
{% block header_title %}New Deployment{% endblock %}

{% block content %}
<div class="webops-page-header">
    <div>
        <h2 class="webops-page-title">Create New Deployment</h2>
        <p class="webops-text-muted">Deploy a new application to your server</p>
    </div>
    <a href="{% url 'deployments:deployment_list' %}" class="webops-btn webops-btn-secondary">
        <span class="material-icons">arrow_back</span>
        Back to Deployments
    </a>
</div>

{% if github_connected and github_repos %}
<!-- GitHub Repository Browser -->
<div class="webops-card" style="margin-bottom: var(--webops-space-3);">
    <div class="webops-card-header" style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: var(--webops-space-3);">
            <span class="material-icons" style="color: var(--webops-color-primary);">folder_special</span>
            <h3 class="webops-h3" style="margin: 0;">Select from Your GitHub Repositories</h3>
        </div>
        <span class="webops-badge webops-badge-success">{{ github_repos|length }} repos</span>
    </div>
    <div class="webops-card-body">
        <!-- Search Box -->
        <div class="webops-form-group" style="margin-bottom: var(--webops-space-3);">
            <div style="position: relative;">
                <span class="material-icons" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--webops-color-text-tertiary); font-size: 20px;">search</span>
                <input type="text" id="repoSearch" class="webops-input" placeholder="Search repositories..." style="padding-left: 40px;" autocomplete="off">
            </div>
        </div>

        <!-- Repository Grid -->
        <div id="repoGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: var(--webops-space-3); max-height: 500px; overflow-y: auto; padding: 2px;">
            {% for repo in github_repos %}
            <div class="repo-card" data-repo-name="{{ repo.name|lower }}" data-repo-desc="{{ repo.description|lower }}" data-repo-fullname="{{ repo.full_name }}">
                <div style="padding: var(--webops-space-3); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: var(--webops-radius-md); background: var(--webops-color-bg-secondary); cursor: pointer; transition: all var(--webops-transition-fast); height: 100%;">
                    <!-- Header -->
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: var(--webops-space-3);">
                        <div style="flex: 1; min-width: 0;">
                            <h4 class="webops-h4" style="margin: 0 0 var(--webops-space-0-5) 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ repo.name }}
                            </h4>
                            <p class="webops-text-xs webops-text-tertiary" style="margin: 0;">{{ repo.full_name }}</p>
                        </div>
                        {% if repo.private %}
                        <span class="webops-badge" style="background: rgba(255, 191, 0, 0.2); color: var(--webops-color-warning); font-size: 11px;">
                            <span class="material-icons" style="font-size: 12px;">lock</span>
                            Private
                        </span>
                        {% else %}
                        <span class="webops-badge" style="background: rgba(0, 255, 136, 0.2); color: var(--webops-color-success); font-size: 11px;">
                            <span class="material-icons" style="font-size: 12px;">public</span>
                            Public
                        </span>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    {% if repo.description %}
                    <p class="webops-text-sm webops-text-secondary" style="margin: 0 0 var(--webops-space-3) 0; height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                        {{ repo.description }}
                    </p>
                    {% else %}
                    <p class="webops-text-sm webops-text-tertiary" style="margin: 0 0 var(--webops-space-3) 0; height: 40px; font-style: italic;">
                        No description provided
                    </p>
                    {% endif %}

                    <!-- Metadata -->
                    <div style="display: flex; align-items: center; gap: var(--webops-space-3); flex-wrap: wrap; margin-bottom: var(--webops-space-3);">
                        {% if repo.language %}
                        <div style="display: flex; align-items: center; gap: var(--webops-space-0-5);">
                            <span class="material-icons webops-text-tertiary" style="font-size: 16px;">code</span>
                            <span class="webops-text-xs webops-text-secondary">{{ repo.language }}</span>
                        </div>
                        {% endif %}
                        <div style="display: flex; align-items: center; gap: var(--webops-space-0-5);">
                            <span class="material-icons webops-text-tertiary" style="font-size: 16px;">star</span>
                            <span class="webops-text-xs webops-text-secondary">{{ repo.stargazers_count }}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--webops-space-0-5);">
                            <span class="material-icons webops-text-tertiary" style="font-size: 16px;">call_split</span>
                            <span class="webops-text-xs webops-text-secondary">{{ repo.forks_count }}</span>
                        </div>
                    </div>

                    <!-- Select Button -->
                    <button type="button" class="webops-btn webops-btn-sm webops-btn-primary" style="width: 100%;" onclick="selectRepository('{{ repo.html_url }}', '{{ repo.full_name }}', '{{ repo.default_branch }}', '{{ repo.name }}')">
                        <span class="material-icons">check_circle</span>
                        Use This Repository
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div id="noResults" style="display: none; text-align: center; padding: var(--webops-space-3); color: var(--webops-color-text-tertiary);">
            <span class="material-icons" style="font-size: 48px; opacity: 0.5;">search_off</span>
            <p class="webops-text-secondary" style="margin-top: var(--webops-space-3);">No repositories match your search</p>
        </div>
    </div>
</div>

<div class="webops-flex webops-gap-sm" style="align-items: center; margin-bottom: var(--webops-space-3); padding: var(--webops-space-3); background: rgba(0, 255, 136, 0.05); border-radius: var(--webops-radius-md); border: 1px solid rgba(0, 255, 136, 0.2);">
    <span class="material-icons webops-text-success">check_circle</span>
    <span class="webops-text-sm webops-text-secondary">Select a repository above or manually enter repository details below</span>
</div>
{% elif github_connected %}
<!-- No repositories found -->
<div class="webops-card" style="margin-bottom: var(--webops-space-3);">
    <div class="webops-card-body" style="text-align: center; padding: var(--webops-space-3);">
        <span class="material-icons" style="font-size: 64px; color: var(--webops-color-text-tertiary); opacity: 0.5;">folder_off</span>
        <h3 class="webops-h3" style="margin-top: var(--webops-space-3); color: var(--webops-color-text-secondary);">No Repositories Found</h3>
        <p class="webops-text-secondary">Your GitHub account doesn't have any repositories yet, or they couldn't be fetched.</p>
        <p class="webops-text-sm webops-text-tertiary" style="margin-top: var(--webops-space-3);">You can still manually enter a repository URL below.</p>
    </div>
</div>
{% else %}
<!-- GitHub not connected -->
<div class="webops-card" style="margin-bottom: var(--webops-space-3);">
    <div class="webops-card-body" style="text-align: center; padding: var(--webops-space-3);">
        <div style="width: 64px; height: 64px; border-radius: var(--webops-radius-lg); background: linear-gradient(135deg, #24292e, #6e5494); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--webops-space-3);">
            <span class="material-icons" style="font-size: 36px; color: white;">code</span>
        </div>
        <h3 class="webops-h3" style="margin-bottom: var(--webops-space-1-5);">Connect GitHub for Quick Deploy</h3>
        <p class="webops-text-secondary" style="margin-bottom: var(--webops-space-3);">Connect your GitHub account to browse and select repositories directly from this page.</p>
        <a href="{% url 'integrations_dashboard' %}" class="webops-btn webops-btn-primary">
            <span class="material-icons">link</span>
            Connect GitHub
        </a>
    </div>
</div>
{% endif %}

<!-- Core Services Status -->
<div class="webops-card webops-mb-lg">
    <div class="webops-card-header" style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
        <div class="webops-flex webops-gap-sm" style="align-items:center;">
            <span class="material-icons">health_and_safety</span>
            <h3 class="webops-h3" style="margin:0;">Prerequisites</h3>
        </div>
        <div class="webops-flex webops-gap-sm" style="align-items:center;">
            {% if core_status.all_ok %}
                <span class="webops-badge webops-badge-success">All services healthy</span>
            {% else %}
                <span class="webops-badge" style="background: rgba(255,191,0,0.2); color: var(--webops-color-warning);">Attention required</span>
            {% endif %}
            <button type="button" class="webops-btn webops-btn-sm webops-btn-secondary" onclick="refreshServiceStatus()" title="Refresh service status">
                <span class="material-icons">refresh</span>
            </button>
        </div>
    </div>
    <div class="webops-card-body">
        <div class="webops-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
            <div class="webops-flex webops-gap-sm" style="align-items:center;justify-content:space-between;">
                <div class="webops-flex webops-gap-sm" style="align-items:center;">
                    <span class="material-icons" style="color: {{ core_status.systemctl|yesno:'var(--webops-color-success),var(--webops-color-danger)' }};">
                        {{ core_status.systemctl|yesno:'check_circle,error' }}
                    </span>
                    <span class="webops-text-sm">systemctl</span>
                </div>
            </div>
            <div class="webops-flex webops-gap-sm" style="align-items:center;justify-content:space-between;">
                <div class="webops-flex webops-gap-sm" style="align-items:center;">
                    <span class="material-icons" id="redis-status-icon" style="color: {{ core_status.services.redis|yesno:'var(--webops-color-success),var(--webops-color-danger)' }};">
                        {{ core_status.services.redis|yesno:'check_circle,error' }}
                    </span>
                    <span class="webops-text-sm">Redis</span>
                </div>
                {% if not core_status.services.redis %}
                    <button type="button" class="webops-btn webops-btn-xs webops-btn-warning" onclick="restartService('redis')" id="redis-restart-btn">
                        <span class="material-icons">refresh</span>
                        Restart
                    </button>
                {% endif %}
            </div>
            <div class="webops-flex webops-gap-sm" style="align-items:center;justify-content:space-between;">
                <div class="webops-flex webops-gap-sm" style="align-items:center;">
                    <span class="material-icons" id="postgresql-status-icon" style="color: {{ core_status.services.postgresql|yesno:'var(--webops-color-success),var(--webops-color-danger)' }};">
                        {{ core_status.services.postgresql|yesno:'check_circle,error' }}
                    </span>
                    <span class="webops-text-sm">PostgreSQL</span>
                </div>
                {% if not core_status.services.postgresql %}
                    <button type="button" class="webops-btn webops-btn-xs webops-btn-warning" onclick="restartService('postgresql')" id="postgresql-restart-btn">
                        <span class="material-icons">refresh</span>
                        Restart
                    </button>
                {% endif %}
            </div>
            <div class="webops-flex webops-gap-sm" style="align-items:center;justify-content:space-between;">
                <div class="webops-flex webops-gap-sm" style="align-items:center;">
                    <span class="material-icons" id="nginx-status-icon" style="color: {{ core_status.services.nginx|yesno:'var(--webops-color-success),var(--webops-color-danger)' }};">
                        {{ core_status.services.nginx|yesno:'check_circle,error' }}
                    </span>
                    <span class="webops-text-sm">Nginx</span>
                </div>
                {% if not core_status.services.nginx %}
                    <button type="button" class="webops-btn webops-btn-xs webops-btn-warning" onclick="restartService('nginx')" id="nginx-restart-btn">
                        <span="material-icons">refresh</span>
                        Restart
                    </button>
                {% endif %}
            </div>
            <div class="webops-flex webops-gap-sm" style="align-items:center;justify-content:space-between;">
                <div class="webops-flex webops-gap-sm" style="align-items:center;">
                    <span class="material-icons" id="celery-status-icon" style="color: {{ core_status.services.celery|yesno:'var(--webops-color-success),var(--webops-color-danger)' }};">
                        {{ core_status.services.celery|yesno:'check_circle,error' }}
                    </span>
                    <span class="webops-text-sm">Celery worker</span>
                </div>
                {% if not core_status.services.celery %}
                    <button type="button" class="webops-btn webops-btn-xs webops-btn-warning" onclick="restartService('celery')" id="celery-restart-btn">
                        <span class="material-icons">refresh</span>
                        Restart
                    </button>
                {% endif %}
            </div>
        </div>
        
        <div id="serviceStatus" style="margin-top: 16px;">
            {% if not core_status.all_ok %}
                <div class="webops-alert webops-alert-warning" style="margin-bottom: 12px;">
                    <div class="webops-flex webops-gap-sm" style="align-items: flex-start;">
                        <span class="material-icons">warning</span>
                        <div>
                            <strong>Service Issues Detected</strong>
                            <p class="webops-text-sm" style="margin-top: 4px;">
                                Some required services are not running. You can try restarting them using the buttons above, or start them manually and refresh this page.
                            </p>
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <div id="serviceActions" class="webops-flex webops-gap-sm" style="flex-wrap: wrap;">
                {% if not core_status.all_ok %}
                    <button type="button" class="webops-btn webops-btn-sm webops-btn-primary" onclick="restartAllServices()">
                        <span class="material-icons">autorenew</span>
                        Restart All Failed Services
                    </button>
                {% endif %}
                <button type="button" class="webops-btn webops-btn-sm webops-btn-secondary" onclick="refreshServiceStatus()">
                    <span class="material-icons">refresh</span>
                    Refresh Status
                </button>
            </div>
        </div>
        
        <div id="serviceMessages" style="margin-top: 12px;"></div>
    </div>
</div>

<!-- Manual Deployment Form -->
<div class="webops-card">
    <div class="webops-card-header">
        <h3 class="webops-h3">Deployment Configuration</h3>
    </div>
    <div class="webops-card-body">
        <form method="POST" id="deploymentForm">
            {% csrf_token %}

            <div class="webops-form-group">
                <label for="name" class="webops-label webops-label-required">Application Name</label>
                <input type="text" id="name" name="name" class="webops-input" required
                       pattern="^[a-z0-9][a-z0-9\-_]*[a-z0-9]$"
                       maxlength="100"
                       placeholder="my-app"
                       autocomplete="off">
                <small class="webops-input-help">Lowercase letters, numbers, hyphens, and underscores. Must start/end with alphanumeric. Max 100 chars.</small>
                <div id="namePreview" class="webops-text-xs webops-text-tertiary" style="margin-top: 4px; display: none;">
                    Sanitized: <code id="nameSanitized"></code>
                </div>
            </div>

            <div class="webops-form-group">
                <label for="repo_url" class="webops-label webops-label-required">Repository URL</label>
                <input type="url" id="repo_url" name="repo_url" class="webops-input" required
                       placeholder="https://github.com/username/repository or git@github.com:username/repository.git"
                       autocomplete="off">
                <small class="webops-input-help">GitHub repository URL (HTTPS or SSH). Private repos require connected GitHub account.</small>
            </div>

            <div class="webops-form-group">
                <label for="branch" class="webops-label">Branch</label>
                <div style="position: relative;">
                    <input type="text" id="branch" name="branch" class="webops-input" value="main"
                           placeholder="main"
                           autocomplete="off">
                    <div id="branchLoader" style="display: none; position: absolute; right: 12px; top: 50%; transform: translateY(-50%);">
                        <div class="webops-spinner" style="width: 20px; height: 20px;"></div>
                    </div>
                </div>
                <div id="branchSelector" style="display: none; margin-top: var(--webops-space-1-5);">
                    <select id="branchSelect" class="webops-input" style="cursor: pointer;">
                        <option value="">Select a branch...</option>
                    </select>
                </div>
                <small class="webops-input-help">Git branch to deploy (default: main)</small>
            </div>

            <div class="webops-form-group">
                <label for="domain" class="webops-label">Domain (optional)</label>
                <input type="text" id="domain" name="domain" class="webops-input"
                       pattern="^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$"
                       placeholder="example.com"
                       autocomplete="off">
                <small class="webops-input-help">Valid domains only (e.g., example.com). Leave empty to use IP + port.</small>
            </div>

            <!-- Docker Options (only shown if docker addon is enabled) -->
            {% if 'docker' in enabled_addon_names %}
            <div class="webops-card" style="margin-bottom: var(--webops-space-3); background: var(--webops-color-bg-secondary);">
                <div class="webops-card-header" style="display: flex; align-items: center; gap: var(--webops-space-2);">
                    <span class="material-icons" style="color: var(--webops-color-info);">widgets</span>
                    <h4 class="webops-h4" style="margin: 0;">Docker Containerization</h4>
                    <span class="webops-badge" style="background: rgba(0, 170, 255, 0.2); color: var(--webops-color-info); font-size: 11px;">Optional</span>
                </div>
                <div class="webops-card-body">
                    <div class="webops-form-group">
                        <label class="webops-flex webops-gap-sm" style="align-items: center; cursor: pointer;">
                            <input type="checkbox" id="use_docker" name="use_docker" style="width: auto;">
                            <span class="webops-label" style="margin: 0;">Use Docker containerization</span>
                        </label>
                        <small class="webops-input-help">Deploy this application in a Docker container for better isolation and portability</small>
                    </div>

                    <div id="dockerOptions" style="display: none; margin-top: var(--webops-space-3); padding-top: var(--webops-space-3); border-top: 1px solid rgba(0, 255, 136, 0.1);">
                        <div class="webops-form-group">
                            <label class="webops-flex webops-gap-sm" style="align-items: center; cursor: pointer;">
                                <input type="checkbox" id="auto_generate_dockerfile" name="auto_generate_dockerfile" checked style="width: auto;">
                                <span class="webops-label" style="margin: 0;">Auto-generate Dockerfile if not present</span>
                            </label>
                            <small class="webops-input-help">WebOps will create an optimized Dockerfile based on your project type</small>
                        </div>

                        <div class="webops-form-group">
                            <label for="dockerfile_path" class="webops-label">Dockerfile Path</label>
                            <input type="text" id="dockerfile_path" name="dockerfile_path" class="webops-input" value="Dockerfile"
                                   placeholder="Dockerfile"
                                   autocomplete="off">
                            <small class="webops-input-help">Path to Dockerfile relative to repository root</small>
                        </div>

                        <div class="webops-form-group">
                            <label for="docker_network_mode" class="webops-label">Network Mode</label>
                            <select id="docker_network_mode" name="docker_network_mode" class="webops-input">
                                <option value="bridge" selected>Bridge (default)</option>
                                <option value="host">Host</option>
                                <option value="none">None</option>
                            </select>
                            <small class="webops-input-help">Docker network mode for the container</small>
                        </div>

                        <div class="webops-p-md" style="background: rgba(0, 170, 255, 0.1); border-radius: var(--webops-radius-md); border-left: 3px solid var(--webops-color-info);">
                            <div class="webops-flex webops-gap-sm" style="align-items: flex-start;">
                                <span class="material-icons webops-text-info" style="font-size: 18px;">info</span>
                                <div class="webops-text-xs">
                                    <strong>Docker Benefits:</strong>
                                    <ul style="margin: 4px 0 0 0; padding-left: 20px;">
                                        <li>Consistent runtime environment</li>
                                        <li>Better resource isolation</li>
                                        <li>Easy scaling and updates</li>
                                        <li>Compatible with vLLM and other containerized services</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="webops-p-md webops-mb-lg" style="background: rgba(0, 170, 255, 0.1); border-radius: var(--webops-radius-md); border-left: 4px solid var(--webops-color-info);">
                <div class="webops-flex webops-gap-sm" style="align-items: flex-start;">
                    <span class="material-icons webops-text-info" style="font-size: 20px;">info</span>
                    <div class="webops-text-sm">
                        <strong class="webops-font-semibold">Deployment Process</strong>
                        <p class="webops-text-secondary" style="margin: 4px 0 0 0;">
                            The deployment will automatically clone your repository, install dependencies, and start your application.
                            You can monitor the progress in the deployment details page.
                        </p>
                    </div>
                </div>
            </div>

            <div class="webops-flex webops-gap-sm">
                <button type="submit" class="webops-btn webops-btn-primary" {% if not core_status.all_ok %}disabled aria-disabled="true"{% endif %}>
                    <span class="material-icons">rocket_launch</span>
                    Create Deployment
                </button>
                <a href="{% url 'deployments:deployment_list' %}" class="webops-btn webops-btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
// Repository search
const searchInput = document.getElementById('repoSearch');
if (searchInput) {
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const repoCards = document.querySelectorAll('.repo-card');
        let visibleCount = 0;

        repoCards.forEach(card => {
            const name = card.dataset.repoName;
            const desc = card.dataset.repoDesc;

            if (name.includes(searchTerm) || desc.includes(searchTerm)) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Show/hide no results message
        const noResults = document.getElementById('noResults');
        const repoGrid = document.getElementById('repoGrid');
        if (visibleCount === 0) {
            repoGrid.style.display = 'none';
            noResults.style.display = 'block';
        } else {
            repoGrid.style.display = 'grid';
            noResults.style.display = 'none';
        }
    });
}

// Select repository
function selectRepository(repoUrl, fullName, defaultBranch, repoName) {
    // Auto-fill form fields
    document.getElementById('repo_url').value = repoUrl;
    document.getElementById('branch').value = defaultBranch || 'main';

    // Auto-generate app name from repo name and show sanitized preview
    const rawName = repoName || '';
    const sanitized = sanitizeNameClient(rawName);
    document.getElementById('name').value = sanitized;
    showSanitizedPreview(rawName);

    // Scroll to form
    const form = document.getElementById('deploymentForm');
    if (form) {
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Highlight form briefly - fix null reference
    const cards = document.querySelectorAll('.webops-card');
    const lastCard = cards[cards.length - 1];
    if (lastCard) {
        lastCard.style.boxShadow = '0 0 0 3px rgba(0, 255, 136, 0.3)';
        setTimeout(() => {
            lastCard.style.boxShadow = '';
        }, 2000);
    }

    // Fetch branches
    fetchBranches(fullName);
}

// Basic client-side sanitization that mirrors server rules
function sanitizeNameClient(name) {
    if (!name) return '';
    let s = name.trim().toLowerCase();
    s = s.replace(/[^a-z0-9-_]/g, '-');
    s = s.replace(/-+/g, '-');
    s = s.replace(/(^-+|-+$)/g, '');
    if (!s) return '';
    if (!/^[a-z0-9]/.test(s)) s = 'app-' + s;
    if (!/[a-z0-9]$/.test(s)) s = s + '-app';
    // Enforce max length 100
    if (s.length > 100) s = s.slice(0, 100);
    return s;
}

function showSanitizedPreview(raw) {
    const preview = document.getElementById('namePreview');
    const code = document.getElementById('nameSanitized');
    const sanitized = sanitizeNameClient(raw || document.getElementById('name').value);
    if (!sanitized) {
        preview.style.display = 'none';
        code.textContent = '';
        return;
    }
    code.textContent = sanitized;
    preview.style.display = 'block';
}

// Live preview as user types
const nameInput = document.getElementById('name');
if (nameInput) {
    nameInput.addEventListener('input', function() {
        showSanitizedPreview(this.value);
    });
}

// Fetch branches when repo URL changes
{% if github_connected %}
let currentRepo = null;

document.getElementById('repo_url').addEventListener('blur', function() {
    const url = this.value.trim();
    if (url.includes('github.com/')) {
        // Extract owner/repo from URL
        const match = url.match(/github\.com\/([^\/]+\/[^\/]+)/);
        if (match) {
            const fullName = match[1].replace(/\.git$/, '');
            if (fullName !== currentRepo) {
// Disable submit if prerequisites not met (progressive enhancement)
(function(){
    try {
        const submitBtn = document.querySelector('#deploymentForm button[type="submit"]');
        const allOk = {{ core_status.all_ok|yesno:'true,false' }};
        if (!allOk && submitBtn) {
            submitBtn.setAttribute('disabled', 'disabled');
            submitBtn.setAttribute('aria-disabled', 'true');
        }
    } catch(e) {}
})();
                currentRepo = fullName;
                fetchBranches(fullName);
            }
        }
    }
});

function fetchBranches(fullName) {
    const branchLoader = document.getElementById('branchLoader');
    const branchSelector = document.getElementById('branchSelector');
    const branchSelect = document.getElementById('branchSelect');

    branchLoader.style.display = 'block';
    branchSelector.style.display = 'none';

    fetch(`{% url 'deployments:github_repo_branches' %}?repo=${encodeURIComponent(fullName)}`)
        .then(response => response.json())
        .then(data => {
            branchLoader.style.display = 'none';

            if (data.success && data.branches.length > 0) {
                branchSelect.innerHTML = '<option value="">Select a branch...</option>';
                data.branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch;
                    branchSelect.appendChild(option);
                });

                // Set current branch value as selected
                const currentBranch = document.getElementById('branch').value;
                if (currentBranch && data.branches.includes(currentBranch)) {
                    branchSelect.value = currentBranch;
                }

                branchSelector.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Failed to fetch branches:', error);
            branchLoader.style.display = 'none';
        });
}

// Update branch input when selection changes
document.getElementById('branchSelect').addEventListener('change', function() {
    if (this.value) {
        document.getElementById('branch').value = this.value;
    }
});
{% endif %}

// On submit, show loader
document.getElementById('deploymentForm').addEventListener('submit', function() {
    showLoader();
});

// Docker options toggle (only if Docker addon is enabled)
const useDockerCheckbox = document.getElementById('use_docker');
if (useDockerCheckbox) {
    useDockerCheckbox.addEventListener('change', function() {
        const dockerOptions = document.getElementById('dockerOptions');
        if (dockerOptions) {
            if (this.checked) {
                dockerOptions.style.display = 'block';
            } else {
                dockerOptions.style.display = 'none';
            }
        }
    });
}

// Service Management Functions
function refreshCoreServices() {
    const refreshBtn = document.getElementById('refreshServicesBtn');
    const refreshIcon = refreshBtn.querySelector('i');
    
    // Show loading state
    refreshIcon.className = 'fas fa-spinner fa-spin';
    refreshBtn.disabled = true;
    
    fetch('{% url "deployments:core_services_status_detailed" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateServiceStatusDisplay(data.services);
                showNotification('Services status refreshed', 'success');
            } else {
                showNotification('Failed to refresh services status', 'error');
            }
        })
        .catch(error => {
            console.error('Error refreshing services:', error);
            showNotification('Error refreshing services status', 'error');
        })
        .finally(() => {
            refreshIcon.className = 'fas fa-sync-alt';
            refreshBtn.disabled = false;
        });
}

function restartService(serviceName) {
    const restartBtn = document.getElementById(`restart-${serviceName}`);
    if (!restartBtn) return;
    
    const originalText = restartBtn.innerHTML;
    restartBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restarting...';
    restartBtn.disabled = true;
    
    fetch(`{% url "deployments:restart_core_service" "SERVICE_NAME" %}`.replace('SERVICE_NAME', serviceName))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`${serviceName} restarted successfully`, 'success');
                // Refresh the service status after restart
                setTimeout(() => refreshCoreServices(), 2000);
            } else {
                showNotification(`Failed to restart ${serviceName}: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            console.error(`Error restarting ${serviceName}:`, error);
            showNotification(`Error restarting ${serviceName}`, 'error');
        })
        .finally(() => {
            restartBtn.innerHTML = originalText;
            restartBtn.disabled = false;
        });
}

function restartAllFailedServices() {
    const failedServices = document.querySelectorAll('.service-item .text-danger');
    const serviceNames = Array.from(failedServices).map(el => {
        const serviceItem = el.closest('.service-item');
        return serviceItem ? serviceItem.dataset.service : null;
    }).filter(name => name);
    
    if (serviceNames.length === 0) {
        showNotification('No failed services to restart', 'info');
        return;
    }
    
    const restartBtn = document.getElementById('restartAllFailedBtn');
    const originalText = restartBtn.innerHTML;
    restartBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restarting All...';
    restartBtn.disabled = true;
    
    let restartPromises = serviceNames.map(serviceName => 
        fetch(`{% url "deployments:restart_core_service" "SERVICE_NAME" %}`.replace('SERVICE_NAME', serviceName))
            .then(response => response.json())
            .then(data => ({ service: serviceName, success: data.success, message: data.message }))
            .catch(error => ({ service: serviceName, success: false, message: error.message }))
    );
    
    Promise.all(restartPromises)
        .then(results => {
            const successful = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;
            
            if (successful > 0) {
                showNotification(`Successfully restarted ${successful} service(s)`, 'success');
            }
            if (failed > 0) {
                showNotification(`Failed to restart ${failed} service(s)`, 'error');
            }
            
            // Refresh status after all restarts
            setTimeout(() => refreshCoreServices(), 2000);
        })
        .finally(() => {
            restartBtn.innerHTML = originalText;
            restartBtn.disabled = false;
        });
}

function updateServiceStatusDisplay(services) {
    services.forEach(service => {
        const serviceItem = document.querySelector(`[data-service="${service.name}"]`);
        if (!serviceItem) return;
        
        const statusIcon = serviceItem.querySelector('.service-status i');
        const statusText = serviceItem.querySelector('.service-status');
        const restartBtn = serviceItem.querySelector('.restart-btn');
        
        if (service.active) {
            statusIcon.className = 'fas fa-check-circle text-success';
            statusText.innerHTML = '<i class="fas fa-check-circle text-success"></i> Running';
            if (restartBtn) restartBtn.style.display = 'none';
        } else {
            statusIcon.className = 'fas fa-times-circle text-danger';
            statusText.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Stopped';
            if (restartBtn) restartBtn.style.display = 'inline-block';
        }
    });
    
    // Update overall status
    const allOk = services.every(service => service.active);
    const warningAlert = document.getElementById('serviceWarning');
    const submitBtn = document.querySelector('#deploymentForm button[type="submit"]');
    
    if (allOk) {
        warningAlert.style.display = 'none';
        if (submitBtn) {
            submitBtn.removeAttribute('disabled');
            submitBtn.removeAttribute('aria-disabled');
        }
    } else {
        warningAlert.style.display = 'block';
        if (submitBtn) {
            submitBtn.setAttribute('disabled', 'disabled');
            submitBtn.setAttribute('aria-disabled', 'true');
        }
    }
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
    
    // Manual dismiss
    notification.querySelector('.close').addEventListener('click', function() {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    });
}

// Add event listeners for service management buttons
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refreshServicesBtn');
    const restartAllBtn = document.getElementById('restartAllFailedBtn');
    
    if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshCoreServices);
    }
    
    if (restartAllBtn) {
        restartAllBtn.addEventListener('click', restartAllFailedServices);
    }
    
    // Add click listeners to individual restart buttons
    document.querySelectorAll('.restart-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const serviceName = this.dataset.service;
            if (serviceName) {
                restartService(serviceName);
            }
        });
    });
});
</script>
{% endblock %}
