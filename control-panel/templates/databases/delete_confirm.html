{% extends 'base.html' %}

{% block title %}Delete Database - WebOps{% endblock %}

{% block content %}
<div class="webops-page-header">
    <div>
        <h2 class="webops-page-title">Delete Database</h2>
        <p class="webops-text-muted">Permanently delete database and associated credentials</p>
    </div>
    <a href="{% url 'database_detail' database.pk %}" class="webops-btn webops-btn-secondary">← Back to Database</a>
</div>

<!-- Warning Card -->
<div class="webops-card warning-card webops-max-w-md webops-mx-auto">
    <div class="webops-card-header webops-bg-error webops-text-white">
        <div class="webops-flex webops-items-center webops-gap-md">
            <span class="material-icons webops-icon--large">warning</span>
            <div>
                <h3 class="webops-h3 webops-m-0 webops-text-white">Danger Zone - Irreversible Action</h3>
                <p class="webops-mt-sm webops-opacity-90">This action cannot be undone. All data will be permanently lost.</p>
            </div>
        </div>
    </div>
    <div class="webops-card-body">
        <div class="database-info">
            <h4 class="webops-h4 webops-mb-md webops-text-gray-700">Database Details</h4>

            <div class="info-grid">
                <div class="info-row">
                    <span class="info-label">Database Name:</span>
                    <code class="webops-info-value">{{ database.name }}</code>
                </div>
                <div class="info-row">
                    <span class="info-label">Username:</span>
                    <code class="webops-info-value">{{ database.username }}</code>
                </div>
                <div class="info-row">
                    <span class="info-label">Host:</span>
                    <code class="webops-info-value">{{ database.host }}</code>
                </div>
                <div class="info-row">
                    <span class="info-label">Port:</span>
                    <code class="webops-info-value">{{ database.port }}</code>
                </div>
                {% if database.deployment %}
                <div class="info-row">
                    <span class="info-label">Associated Deployment:</span>
                    <a href="{% url 'deployments:deployment_detail' database.deployment.pk %}" class="deployment-link">
                        {{ database.deployment.name }}
                    </a>
                </div>
                {% endif %}
                <div class="info-row">
                    <span class="info-label">Created:</span>
                    <span class="webops-info-value">{{ database.created_at|date:"F j, Y, g:i a" }}</span>
                </div>
            </div>
        </div>

        <div class="impact-section">
            <h4 class="webops-h4 webops-mb-md webops-text-error">What Will Be Deleted:</h4>
            <ul class="impact-list">
                <li>
                    <span class="material-icons impact-icon">storage</span>
                    <div>
                        <strong>Database:</strong> The entire <code>{{ database.name }}</code> database will be dropped
                    </div>
                </li>
                <li>
                    <span class="material-icons impact-icon">person</span>
                    <div>
                        <strong>Database User:</strong> User <code>{{ database.username }}</code> will be removed
                    </div>
                </li>
                <li>
                    <span class="material-icons impact-icon">data_object</span>
                    <div>
                        <strong>All Data:</strong> All tables, rows, indexes, and database contents will be permanently lost
                    </div>
                </li>
                <li>
                    <span class="material-icons impact-icon">lock</span>
                    <div>
                        <strong>Credentials:</strong> Stored credentials will be removed from WebOps
                    </div>
                </li>
                {% if database.deployment %}
                <li>
                    <span class="material-icons impact-icon">warning</span>
                    <div>
                        <strong>Deployment Impact:</strong> The deployment <strong>{{ database.deployment.name }}</strong> will lose its database connection
                    </div>
                </li>
                {% endif %}
            </ul>
        </div>

        <div class="confirmation-section">
            <form method="POST" id="delete-form">
                {% csrf_token %}

                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="confirm-checkbox" required>
                        <span class="checkbox-text">
                            I understand that this action is permanent and cannot be undone
                        </span>
                    </label>
                </div>

                <div class="form-actions webops-flex webops-gap-sm">
                    <button type="submit" class="webops-btn webops-btn-danger btn-large" id="delete-btn" disabled>
                        <span id="delete-text">Permanently Delete Database</span>
                        <span id="delete-loading" class="webops-hidden">Deleting...</span>
                    </button>
                    <a href="{% url 'database_detail' database.pk %}" class="webops-btn webops-btn-secondary btn-large">
                        ← Cancel and Go Back
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Safety Tips -->
<div class="webops-card webops-max-w-md webops-mx-auto webops-mt-lg webops-border-l-primary">
    <div class="webops-card-body">
        <h4 class="webops-h3 webops-text-primary webops-mb-md">Before You Delete</h4>
        <ul class="help-list">
            <li>
                <strong>Backup First:</strong> Consider backing up your data using <code>pg_dump</code> before deletion
            </li>
            <li>
                <strong>Check Dependencies:</strong> Verify that no applications are actively using this database
            </li>
            <li>
                <strong>Alternative:</strong> If temporarily unused, you can keep the database for future use
            </li>
        </ul>
    </div>
</div>

<style>
.warning-card {
    border: 3px solid var(--webops-color-error);
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15);
}

.database-info {
    padding: var(--webops-space-3);
    background: var(--webops-color-bg-tertiary);
    border-radius: var(--webops-radius-md);
    margin-bottom: var(--webops-space-3);
}

.info-grid {
    display: flex;
    flex-direction: column;
    gap: var(--webops-space-1-5);
}

.info-row {
    display: flex;
    align-items: center;
    gap: var(--webops-space-3);
}

.info-label {
    font-weight: var(--webops-font-weight-semibold);
    color: var(--webops-color-text-primary);
    min-width: 180px;
}

.info-value {
    background: var(--webops-color-surface);
    padding: var(--webops-space-0-5) var(--webops-space-1-5);
    border-radius: var(--webops-radius-sm);
    font-family: var(--webops-font-family-mono);
    font-size: var(--webops-font-size-sm);
}

.deployment-link {
    color: var(--webops-color-primary);
    text-decoration: none;
    font-weight: var(--webops-font-weight-semibold);
}

.deployment-link:hover {
    text-decoration: underline;
}

.impact-section {
    padding: var(--webops-space-3);
    background: linear-gradient(135deg, var(--webops-color-error-alpha-10) 0%, var(--webops-color-error-alpha-20) 100%);
    border-radius: var(--webops-radius-md);
    border: 2px solid var(--webops-color-error-alpha-30);
    margin-bottom: var(--webops-space-3);
}

.impact-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.impact-list li {
    display: flex;
    align-items: flex-start;
    gap: var(--webops-space-3);
    padding: var(--webops-space-3);
    background: var(--webops-color-surface);
    border-radius: var(--webops-radius-md);
    margin-bottom: var(--webops-space-1-5);
    border: 1px solid var(--webops-color-error-alpha-20);
}

.impact-list li:last-child {
    margin-bottom: 0;
}

.impact-icon {
    font-size: 24px;
    flex-shrink: 0;
    color: var(--webops-color-error);
}

.impact-list code {
    background: var(--webops-color-primary-alpha-10);
    padding: var(--webops-space-0-5) var(--webops-space-1);
    border-radius: var(--webops-radius-sm);
    font-size: var(--webops-font-size-sm);
}

.confirmation-section {
    padding-top: var(--webops-space-3);
    border-top: 2px solid var(--webops-color-primary-alpha-20);
}

.checkbox-group {
    margin-bottom: var(--webops-space-3);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--webops-space-1-5);
    cursor: pointer;
    padding: var(--webops-space-3);
    background: var(--webops-color-bg-tertiary);
    border-radius: var(--webops-radius-md);
    border: 2px solid var(--webops-color-primary-alpha-20);
    transition: all var(--webops-transition-fast);
}

.checkbox-label:hover {
    background: var(--webops-color-surface-hover);
    border-color: var(--webops-color-primary);
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--webops-color-primary);
}

.checkbox-text {
    font-weight: var(--webops-font-weight-semibold);
    color: var(--webops-color-text-primary);
}

.form-actions {
    display: flex;
    gap: var(--webops-space-3);
    flex-wrap: wrap;
}

.btn-large {
    padding: var(--webops-space-2-5) var(--webops-space-4);
    font-size: var(--webops-font-size-base);
    font-weight: var(--webops-font-weight-semibold);
}

.btn-danger {
    background: var(--webops-color-error);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background: var(--webops-color-error-dark);
    transform: translateY(-1px);
}

.btn-danger:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--webops-color-primary-alpha-30);
    color: var(--webops-color-primary);
}

.btn-outline:hover {
    background: var(--webops-color-primary-alpha-10);
    border-color: var(--webops-color-primary);
}

.help-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.help-list li {
    padding: var(--webops-space-1-5) 0;
    border-bottom: 1px solid var(--webops-color-primary-alpha-10);
}

.help-list li:last-child {
    border-bottom: none;
}

.help-list strong {
    color: var(--webops-color-text-primary);
}

.help-list code {
    background: var(--webops-color-primary-alpha-10);
    padding: var(--webops-space-0-5) var(--webops-space-1);
    border-radius: var(--webops-radius-sm);
    font-size: var(--webops-font-size-sm);
}
</style>

<script>
// Enable delete button only when checkbox is checked
const confirmCheckbox = document.getElementById('confirm-checkbox');
const deleteBtn = document.getElementById('delete-btn');

confirmCheckbox.addEventListener('change', function() {
    deleteBtn.disabled = !this.checked;
    if (this.checked) {
        deleteBtn.classList.remove('webops-opacity-50');
        deleteBtn.classList.add('webops-cursor-pointer');
    } else {
        deleteBtn.classList.add('webops-opacity-50');
        deleteBtn.classList.remove('webops-cursor-pointer');
    }
});

// Handle form submission
document.getElementById('delete-form').addEventListener('submit', function(e) {
    const deleteText = document.getElementById('delete-text');
    const deleteLoading = document.getElementById('delete-loading');

    deleteText.classList.add('webops-hidden');
    deleteLoading.classList.remove('webops-hidden');

    // Disable form inputs
    const inputs = this.querySelectorAll('input, button');
    inputs.forEach(input => input.disabled = true);
});

// Warn if user tries to leave page
let formSubmitted = false;
document.getElementById('delete-form').addEventListener('submit', function() {
    formSubmitted = true;
});

window.addEventListener('beforeunload', function(e) {
    if (!formSubmitted && confirmCheckbox.checked) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
{% endblock %}