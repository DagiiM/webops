{% extends 'auth/auth_base.html' %}

{% block title %}Set New Password - WebOps{% endblock %}
{% block page_title %}Set New Password{% endblock %}
{% block card_max_width %}480px{% endblock %}

{% block content %}
<div class="auth-alert auth-alert-info" role="alert">
    <span class="material-icons">info</span>
    <span>Choose a strong password that you haven't used before.</span>
</div>

<form method="post" id="resetConfirmForm" novalidate>
    {% csrf_token %}

    <div class="auth-form-group">
        <label for="{{ form.new_password1.id_for_label }}" class="webops-label">New Password</label>
        <div class="auth-input-wrapper">
            {{ form.new_password1 }}
            <button type="button" class="password-toggle" id="togglePassword1" aria-label="Toggle password visibility">
                <span class="material-icons">visibility_off</span>
            </button>
        </div>
        <div class="auth-feedback" id="password1-feedback" role="alert"></div>

        <!-- Password Strength Meter -->
        <div class="password-strength" id="passwordStrength" style="display: none;">
            <div class="password-strength-label">
                Password strength: <span id="strengthText">Weak</span>
            </div>
            <div class="password-strength-bar">
                <div class="password-strength-fill" id="strengthBar"></div>
            </div>
        </div>

        <!-- Password Requirements -->
        <div class="password-requirements" id="passwordRequirements" style="display: none;">
            <div class="password-requirement" id="req-length">
                <span class="material-icons">radio_button_unchecked</span>
                <span>At least 8 characters</span>
            </div>
            <div class="password-requirement" id="req-uppercase">
                <span class="material-icons">radio_button_unchecked</span>
                <span>One uppercase letter</span>
            </div>
            <div class="password-requirement" id="req-lowercase">
                <span class="material-icons">radio_button_unchecked</span>
                <span>One lowercase letter</span>
            </div>
            <div class="password-requirement" id="req-number">
                <span class="material-icons">radio_button_unchecked</span>
                <span>One number</span>
            </div>
        </div>

        {% if form.new_password1.errors %}
            <div class="auth-feedback show error">
                <span class="material-icons">error</span>
                <span>{{ form.new_password1.errors|first }}</span>
            </div>
        {% endif %}
    </div>

    <div class="auth-form-group">
        <label for="{{ form.new_password2.id_for_label }}" class="webops-label">Confirm New Password</label>
        <div class="auth-input-wrapper">
            {{ form.new_password2 }}
            <button type="button" class="password-toggle" id="togglePassword2" aria-label="Toggle password visibility">
                <span class="material-icons">visibility_off</span>
            </button>
        </div>
        <div class="auth-feedback" id="password2-feedback" role="alert"></div>
        {% if form.new_password2.errors %}
            <div class="auth-feedback show error">
                <span class="material-icons">error</span>
                <span>{{ form.new_password2.errors|first }}</span>
            </div>
        {% endif %}
    </div>

    <button type="submit" class="webops-btn webops-btn-primary webops-w-full" id="submitBtn">
        Reset Password
    </button>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    'use strict';

    const form = document.getElementById('resetConfirmForm');
    const password1Input = document.getElementById('{{ form.new_password1.id_for_label }}');
    const password2Input = document.getElementById('{{ form.new_password2.id_for_label }}');
    const submitBtn = document.getElementById('submitBtn');

    // Add placeholders and classes
    password1Input.placeholder = 'Enter your new password';
    password1Input.className = 'auth-input';
    password1Input.autocomplete = 'new-password';
    password1Input.style.paddingRight = 'var(--webops-space-6)';
    password1Input.setAttribute('aria-describedby', 'password1-feedback');
    password1Input.autofocus = true;

    password2Input.placeholder = 'Confirm your new password';
    password2Input.className = 'auth-input';
    password2Input.autocomplete = 'new-password';
    password2Input.style.paddingRight = 'var(--webops-space-6)';
    password2Input.setAttribute('aria-describedby', 'password2-feedback');

    // Password visibility toggles
    document.getElementById('togglePassword1').addEventListener('click', function() {
        const type = password1Input.type === 'password' ? 'text' : 'password';
        password1Input.type = type;
        this.querySelector('.material-icons').textContent = type === 'password' ? 'visibility_off' : 'visibility';
    });

    document.getElementById('togglePassword2').addEventListener('click', function() {
        const type = password2Input.type === 'password' ? 'text' : 'password';
        password2Input.type = type;
        this.querySelector('.material-icons').textContent = type === 'password' ? 'visibility_off' : 'visibility';
    });

    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /[0-9]/.test(password)
        };

        // Update requirement indicators
        updateRequirement('req-length', requirements.length);
        updateRequirement('req-uppercase', requirements.uppercase);
        updateRequirement('req-lowercase', requirements.lowercase);
        updateRequirement('req-number', requirements.number);

        // Calculate strength
        if (requirements.length) strength++;
        if (requirements.uppercase) strength++;
        if (requirements.lowercase) strength++;
        if (requirements.number) strength++;

        return { strength, requirements };
    }

    function updateRequirement(id, met) {
        const el = document.getElementById(id);
        const icon = el.querySelector('.material-icons');

        if (met) {
            el.classList.add('met');
            icon.textContent = 'check_circle';
        } else {
            el.classList.remove('met');
            icon.textContent = 'radio_button_unchecked';
        }
    }

    // Password validation
    function validatePassword1() {
        const value = password1Input.value;
        const feedback = document.getElementById('password1-feedback');
        const strengthDiv = document.getElementById('passwordStrength');
        const requirementsDiv = document.getElementById('passwordRequirements');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');

        if (value === '') {
            password1Input.classList.remove('valid', 'invalid');
            feedback.classList.remove('show');
            strengthDiv.style.display = 'none';
            requirementsDiv.style.display = 'none';
            return false;
        }

        // Show strength meter and requirements
        strengthDiv.style.display = 'block';
        requirementsDiv.style.display = 'block';

        const { strength, requirements } = checkPasswordStrength(value);

        // Update strength bar
        strengthBar.className = 'password-strength-fill';
        if (strength <= 2) {
            strengthBar.classList.add('weak');
            strengthText.textContent = 'Weak';
        } else if (strength === 3) {
            strengthBar.classList.add('medium');
            strengthText.textContent = 'Medium';
        } else {
            strengthBar.classList.add('strong');
            strengthText.textContent = 'Strong';
        }

        // Validate
        const allMet = Object.values(requirements).every(met => met);
        if (!allMet) {
            password1Input.classList.remove('valid');
            password1Input.classList.add('invalid');
            return false;
        }

        password1Input.classList.remove('invalid');
        password1Input.classList.add('valid');
        feedback.classList.remove('show');
        return true;
    }

    // Confirm password validation
    function validatePassword2() {
        const value = password2Input.value;
        const password1Value = password1Input.value;
        const feedback = document.getElementById('password2-feedback');

        if (value === '') {
            password2Input.classList.remove('valid', 'invalid');
            feedback.classList.remove('show');
            return false;
        }

        if (value !== password1Value) {
            password2Input.classList.remove('valid');
            password2Input.classList.add('invalid');
            feedback.innerHTML = '<span class="material-icons">error</span><span>Passwords do not match</span>';
            feedback.classList.add('show', 'error');
            return false;
        }

        password2Input.classList.remove('invalid');
        password2Input.classList.add('valid');
        feedback.innerHTML = '<span class="material-icons">check_circle</span><span>Passwords match</span>';
        feedback.classList.add('show', 'success');
        feedback.classList.remove('error');
        return true;
    }

    // Attach event listeners
    password1Input.addEventListener('input', function() {
        validatePassword1();
        if (password2Input.value) validatePassword2();
    });
    password1Input.addEventListener('blur', validatePassword1);
    password2Input.addEventListener('input', validatePassword2);
    password2Input.addEventListener('blur', validatePassword2);

    // Form submission
    form.addEventListener('submit', function(e) {
        const password1Valid = validatePassword1();
        const password2Valid = validatePassword2();

        if (!password1Valid || !password2Valid) {
            e.preventDefault();

            if (!password1Valid) {
                password1Input.focus();
            } else if (!password2Valid) {
                password2Input.focus();
            }
            return false;
        }

        // Add loading state
        submitBtn.classList.add('auth-btn-loading');
        submitBtn.textContent = 'Resetting...';
    });
})();
</script>
{% endblock %}
