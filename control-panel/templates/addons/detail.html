{% extends 'base.html' %}
{% load static %}
{% block title %}{{ addon.name }} - Addon Details{% endblock %}

{% block extra_css_first %}
<link rel="stylesheet" href="{% static 'css/addon-detail.css' %}">
{% endblock %}

{% block content %}
  
<div class="webops-container">
    <!-- Enhanced Header with Gradient Background -->
    <div class="webops-addon-detail__header">
        <div class="webops-addon-detail__header-background"></div>
        <div class="webops-addon-detail__header-content">
            <a href="{% url 'addons:addons_list' %}" class="webops-addon-detail__back-button">
                <span class="material-icons webops-addon-detail__back-button--icon">arrow_back</span>
                Back to Addons
            </a>

            <div class="webops-addon-detail__title-section">
                <div class="webops-addon-detail__title-wrapper">
                    <div class="webops-addon-detail__icon">
                        <span class="material-icons">extension</span>
                        <div class="webops-addon-detail__icon-glow"></div>
                    </div>
                    <div class="webops-addon-detail__title-content">
                        <h1 class="webops-addon-detail__title">{{ addon.name }}</h1>
                        <div class="webops-addon-detail__meta">
                            <span class="webops-addon-detail__meta-item">
                                <span class="material-icons">info</span>
                                Version {{ addon.version }}
                            </span>
                            {% if addon.author %}
                            <span class="webops-addon-detail__meta-item">
                                <span class="material-icons">person</span>
                                {{ addon.author }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="webops-addon-detail__status {% if addon.enabled %}webops-addon-detail__status--active{% else %}webops-addon-detail__status--inactive{% endif %}">
                    <div class="webops-addon-detail__status-indicator {% if addon.enabled %}webops-addon-detail__status-indicator--active{% else %}webops-addon-detail__status-indicator--inactive{% endif %}"></div>
                    <span class="material-icons">{% if addon.enabled %}check_circle{% else %}cancel{% endif %}</span>
                    <span>{% if addon.enabled %}Active{% else %}Inactive{% endif %}</span>
                </div>
            </div>

            <!-- Quick Stats Bar -->
            <div class="webops-addon-detail__quick-stats">
                <div class="webops-addon-detail__quick-stat">
                    <span class="webops-addon-detail__quick-stat-value">{{ total_runs }}</span>
                    <span class="webops-addon-detail__quick-stat-label">Total Runs</span>
                </div>
                <div class="webops-addon-detail__quick-stat">
                    <span class="webops-addon-detail__quick-stat-value">{{ addon.success_count }}</span>
                    <span class="webops-addon-detail__quick-stat-label">Successes</span>
                </div>
                <div class="webops-addon-detail__quick-stat">
                    <span class="webops-addon-detail__quick-stat-value">{{ addon.failure_count }}</span>
                    <span class="webops-addon-detail__quick-stat-label">Failures</span>
                </div>
                {% if total_runs > 0 %}
                <div class="webops-addon-detail__quick-stat">
                    <span class="webops-addon-detail__quick-stat-value">{{ success_rate|floatformat:1 }}%</span>
                    <span class="webops-addon-detail__quick-stat-label">Success Rate</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
    <div style="margin-bottom: var(--webops-space-4);">
        {% for message in messages %}
        <div class="webops-addon-detail__alert
            {% if message.tags == 'success' %}webops-addon-detail__alert--success{% elif message.tags == 'warning' %}webops-addon-detail__alert--warning{% elif message.tags == 'error' %}webops-addon-detail__alert--error{% else %}webops-addon-detail__alert--info{% endif %}">
            <span class="material-icons">
                {% if message.tags == 'success' %}check_circle{% elif message.tags == 'warning' %}warning{% elif message.tags == 'error' %}error{% else %}info{% endif %}
            </span>
            <span>{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Main Content Grid -->
    <div class="webops-addon-detail__grid">
        <!-- Left Column -->
        <div class="webops-addon-detail__main">
            <!-- Description Card -->
            <div class="webops-addon-detail__card">
                <div class="webops-addon-detail__card-header">
                    <div class="webops-addon-detail__card-header-content">
                        <span class="material-icons">description</span>
                        <h3 class="webops-addon-detail__card-title">Description</h3>
                    </div>
                </div>
                <div class="webops-addon-detail__card-body">
                    <p class="webops-addon-detail__description">
                        {{ addon.description|default:"No description available for this addon." }}
                    </p>
                </div>
            </div>

            <!-- Enhanced Capabilities Card -->
            {% load addon_filters %}
            {% if addon.capabilities %}
            <div class="webops-addon-detail__card">
                <div class="webops-addon-detail__card-header">
                    <div class="webops-addon-detail__card-header-content">
                        <span class="material-icons">verified</span>
                        <h3 class="webops-addon-detail__card-title">Capabilities</h3>
                    </div>
                    <div class="webops-addon-detail__capabilities-count">
                        {{ addon.capabilities|length }} feature{{ addon.capabilities|length|pluralize }}
                    </div>
                </div>
                <div class="webops-addon-detail__card-body">
                    <div class="webops-addon-detail__capabilities-grid">
                        {% for capability in addon.capabilities %}
                        <div class="webops-addon-detail__capability-item">
                            <div class="webops-addon-detail__capability-icon">
                                {% if capability == "container_management" %}
                                    <span class="material-icons">inventory_2</span>
                                {% elif capability == "orchestration_generation" %}
                                    <span class="material-icons">auto_awesome</span>
                                {% elif capability == "docker_build" %}
                                    <span class="material-icons">build</span>
                                {% elif capability == "health_monitoring" %}
                                    <span class="material-icons">monitor_heart</span>
                                {% else %}
                                    <span class="material-icons">extension</span>
                                {% endif %}
                            </div>
                            <div class="webops-addon-detail__capability-content">
                                <span class="webops-addon-detail__capability-name">{{ capability|title|replace_string:"_, " }}</span>
                                <div class="webops-addon-detail__capability-status">
                                    <span class="material-icons">check_circle</span>
                                    <span>Available</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Registered Hooks Card -->
            {% if registered_hooks %}
            <div class="webops-addon-detail__card">
                <div class="webops-addon-detail__card-header">
                    <div class="webops-addon-detail__card-header-content">
                        <span class="material-icons">webhook</span>
                        <h3 class="webops-addon-detail__card-title">Registered Hooks</h3>
                    </div>
                    <div class="webops-addon-detail__hooks-summary">
                        <span class="webops-addon-detail__hooks-count">{{ registered_hooks|length }} event{{ registered_hooks|length|pluralize }}</span>
                        <span class="webops-addon-detail__hooks-total">
                            {% with total_hooks=registered_hooks.values|length %}
                            {{ total_hooks }} total hook{{ total_hooks|pluralize }}
                            {% endwith %}
                        </span>
                    </div>
                </div>
                <div class="webops-addon-detail__card-body">
                    <div class="webops-addon-detail__hooks-grid">
                        {% for event, hooks in registered_hooks.items %}
                        <div class="webops-addon-detail__hook-event-card">
                            <div class="webops-addon-detail__hook-event-header">
                                <div class="webops-addon-detail__hook-event-icon">
                                    <span class="material-icons">
                                        {% if event == "pre_deployment" %}
                                            play_circle
                                        {% elif event == "post_deployment" %}
                                            check_circle
                                        {% elif event == "service_health_check" %}
                                            health_and_safety
                                        {% else %}
                                            webhook
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="webops-addon-detail__hook-event-info">
                                    <h4 class="webops-addon-detail__hook-event-title">{{ event|title }}</h4>
                                    <span class="webops-addon-detail__hook-event-count">{{ hooks|length }} hook{{ hooks|length|pluralize }}</span>
                                </div>
                                <div class="webops-addon-detail__hook-event-status">
                                    <div class="webops-addon-detail__status-indicator webops-addon-detail__status-indicator--active"></div>
                                </div>
                            </div>
                            <div class="webops-addon-detail__hook-list">
                                {% for hook in hooks %}
                                <div class="webops-addon-detail__hook-item">
                                    <div class="webops-addon-detail__hook-item-header">
                                        <div class="webops-addon-detail__hook-handler">
                                            <span class="webops-addon-detail__hook-label">Handler</span>
                                            <code class="webops-addon-detail__hook-value">{{ hook.handler_path }}</code>
                                        </div>
                                        <div class="webops-addon-detail__hook-priority-badge webops-addon-detail__hook-priority--{{ hook.priority|lower }}">
                                            Priority {{ hook.priority }}
                                        </div>
                                    </div>
                                    <div class="webops-addon-detail__hook-meta-grid">
                                        {% if hook.timeout_ms %}
                                        <div class="webops-addon-detail__hook-meta-item">
                                            <span class="material-icons">timer</span>
                                            <span class="webops-addon-detail__hook-meta-label">Timeout</span>
                                            <span class="webops-addon-detail__hook-meta-value">{{ hook.timeout_ms }}ms</span>
                                        </div>
                                        {% endif %}
                                        {% if hook.conditions %}
                                        <div class="webops-addon-detail__hook-meta-item">
                                            <span class="material-icons">rule</span>
                                            <span class="webops-addon-detail__hook-meta-label">Conditions</span>
                                            <span class="webops-addon-detail__hook-meta-value">{{ hook.conditions|length }}</span>
                                        </div>
                                        {% endif %}
                                        <div class="webops-addon-detail__hook-meta-item">
                                            <span class="material-icons">schedule</span>
                                            <span class="webops-addon-detail__hook-meta-label">Execution</span>
                                            <span class="webops-addon-detail__hook-meta-value">{{ event|title }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% elif addon.enabled %}
            <div class="webops-addon-detail__card">
                <div class="webops-addon-detail__card-header">
                    <div class="webops-addon-detail__card-header-content">
                        <span class="material-icons">webhook</span>
                        <h3 class="webops-addon-detail__card-title">Registered Hooks</h3>
                    </div>
                </div>
                <div class="webops-addon-detail__card-body">
                    <div class="webops-addon-detail__empty-state">
                        <span class="material-icons">webhook_off</span>
                        <h3>No Hooks Registered</h3>
                        <p>This addon doesn't have any hooks registered for deployment events.</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Last Error Card (if any) -->
            {% if addon.last_error %}
            <div class="webops-addon-detail__card webops-addon-detail__card--error">
                <div class="webops-addon-detail__card-header">
                    <span class="material-icons">error</span>
                    <h3 class="webops-addon-detail__card-title">Last Error</h3>
                </div>
                <div class="webops-addon-detail__card-body">
                    <div class="webops-addon-detail__error-details">
                        <div class="webops-addon-detail__error-time">
                            {% if addon.last_run_at %}
                            <span class="material-icons">schedule</span>
                            {{ addon.last_run_at|date:"F d, Y H:i:s" }}
                            {% endif %}
                        </div>
                        <pre class="webops-addon-detail__error-message">{{ addon.last_error }}</pre>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column - Sidebar -->
        <div class="webops-addon-detail__sidebar">
            <!-- Actions Card -->
            <div class="webops-addon-detail__card">
                <div class="webops-addon-detail__card-header">
                    <div class="webops-addon-detail__card-header-content">
                        <span class="material-icons">settings</span>
                        <h3 class="webops-addon-detail__card-title">Actions</h3>
                    </div>
                </div>
                <div class="webops-addon-detail__card-body">
                    <form method="POST" action="{% url 'addons:addon_toggle' addon.name %}"
                          onsubmit="return confirm('This will {% if addon.enabled %}disable{% else %}enable{% endif %} the {{ addon.name }} addon. A restart is required for changes to take effect. Continue?');">
                        {% csrf_token %}
                        {% if addon.enabled %}
                        <button type="submit" class="webops-addon-detail__action-button webops-addon-detail__action-button--danger">
                            <span class="material-icons">power_settings_new</span>
                            Disable Addon
                        </button>
                        {% else %}
                        <button type="submit" class="webops-addon-detail__action-button webops-addon-detail__action-button--success">
                            <span class="material-icons">power_settings_new</span>
                            Enable Addon
                        </button>
                        {% endif %}
                    </form>

                    <div class="webops-addon-detail__action-note">
                        <span class="material-icons">info</span>
                        <p>Changes require a WebOps restart to take effect.</p>
                    </div>
                </div>
            </div>

            <!-- Enhanced Statistics Card -->
            <div class="webops-addon-detail__card">
                <div class="webops-addon-detail__card-header">
                    <div class="webops-addon-detail__card-header-content">
                        <span class="material-icons">analytics</span>
                        <h3 class="webops-addon-detail__card-title">Performance Statistics</h3>
                    </div>
                </div>
                <div class="webops-addon-detail__card-body">
                    <!-- Main Stats Grid -->
                    <div class="webops-addon-detail__stats-grid">
                        <div class="webops-addon-detail__stat-card webops-addon-detail__stat-card--primary">
                            <div class="webops-addon-detail__stat-icon">
                                <span class="material-icons">play_circle</span>
                            </div>
                            <div class="webops-addon-detail__stat-content">
                                <span class="webops-addon-detail__stat-value">{{ total_runs }}</span>
                                <span class="webops-addon-detail__stat-label">Total Runs</span>
                            </div>
                        </div>

                        <div class="webops-addon-detail__stat-card webops-addon-detail__stat-card--success">
                            <div class="webops-addon-detail__stat-icon">
                                <span class="material-icons">check_circle</span>
                            </div>
                            <div class="webops-addon-detail__stat-content">
                                <span class="webops-addon-detail__stat-value">{{ addon.success_count }}</span>
                                <span class="webops-addon-detail__stat-label">Successes</span>
                            </div>
                        </div>

                        <div class="webops-addon-detail__stat-card webops-addon-detail__stat-card--error">
                            <div class="webops-addon-detail__stat-icon">
                                <span class="material-icons">error</span>
                            </div>
                            <div class="webops-addon-detail__stat-content">
                                <span class="webops-addon-detail__stat-value">{{ addon.failure_count }}</span>
                                <span class="webops-addon-detail__stat-label">Failures</span>
                            </div>
                        </div>

                        {% if addon.last_duration_ms %}
                        <div class="webops-addon-detail__stat-card webops-addon-detail__stat-card--info">
                            <div class="webops-addon-detail__stat-icon">
                                <span class="material-icons">schedule</span>
                            </div>
                            <div class="webops-addon-detail__stat-content">
                                <span class="webops-addon-detail__stat-value">{{ addon.last_duration_ms }}ms</span>
                                <span class="webops-addon-detail__stat-label">Last Duration</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {% if total_runs > 0 %}
                    <!-- Success Rate Visualization -->
                    <div class="webops-addon-detail__success-rate-section">
                        <div class="webops-addon-detail__success-rate-header">
                            <span class="webops-addon-detail__success-rate-label">Success Rate</span>
                            <span class="webops-addon-detail__success-rate-value">{{ success_rate|floatformat:1 }}%</span>
                        </div>
                        <div class="webops-addon-detail__success-rate-bar-container">
                            <div class="webops-addon-detail__success-rate-bar">
                                <div class="webops-addon-detail__success-rate-fill" data-width="{{ success_rate }}">
                                    <div class="webops-addon-detail__success-rate-glow"></div>
                                </div>
                            </div>
                            <div class="webops-addon-detail__success-rate-markers">
                                <span class="webops-addon-detail__rate-marker" style="left: 25%">25%</span>
                                <span class="webops-addon-detail__rate-marker" style="left: 50%">50%</span>
                                <span class="webops-addon-detail__rate-marker" style="left: 75%">75%</span>
                                <span class="webops-addon-detail__rate-marker" style="left: 100%">100%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Indicator -->
                    <div class="webops-addon-detail__performance-indicator">
                        {% if success_rate >= 95 %}
                            <div class="webops-addon-detail__performance-badge webops-addon-detail__performance-badge--excellent">
                                <span class="material-icons">star</span>
                                <span>Excellent Performance</span>
                            </div>
                        {% elif success_rate >= 80 %}
                            <div class="webops-addon-detail__performance-badge webops-addon-detail__performance-badge--good">
                                <span class="material-icons">thumb_up</span>
                                <span>Good Performance</span>
                            </div>
                        {% elif success_rate >= 60 %}
                            <div class="webops-addon-detail__performance-badge webops-addon-detail__performance-badge--fair">
                                <span class="material-icons">warning</span>
                                <span>Fair Performance</span>
                            </div>
                        {% else %}
                            <div class="webops-addon-detail__performance-badge webops-addon-detail__performance-badge--poor">
                                <span class="material-icons">error</span>
                                <span>Needs Attention</span>
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Timeline Card -->
            <div class="webops-addon-detail__card">
                <div class="webops-addon-detail__card-header">
                    <div class="webops-addon-detail__card-header-content">
                        <span class="material-icons">history</span>
                        <h3 class="webops-addon-detail__card-title">Timeline</h3>
                    </div>
                </div>
                <div class="webops-addon-detail__card-body">
                    <div class="webops-addon-detail__timeline">
                        <div class="webops-addon-detail__timeline-item">
                            <span class="material-icons webops-addon-detail__timeline-icon">add_circle</span>
                            <div class="webops-addon-detail__timeline-content">
                                <div class="webops-addon-detail__timeline-label">Created</div>
                                <div class="webops-addon-detail__timeline-value">{{ addon.created_at|date:"F d, Y" }}</div>
                            </div>
                        </div>

                        {% if addon.updated_at %}
                        <div class="webops-addon-detail__timeline-item">
                            <span class="material-icons webops-addon-detail__timeline-icon">update</span>
                            <div class="webops-addon-detail__timeline-content">
                                <div class="webops-addon-detail__timeline-label">Last Updated</div>
                                <div class="webops-addon-detail__timeline-value">{{ addon.updated_at|date:"F d, Y H:i" }}</div>
                            </div>
                        </div>
                        {% endif %}

                        {% if addon.last_run_at %}
                        <div class="webops-addon-detail__timeline-item">
                            <span class="material-icons webops-addon-detail__timeline-icon">play_circle</span>
                            <div class="webops-addon-detail__timeline-content">
                                <div class="webops-addon-detail__timeline-label">Last Run</div>
                                <div class="webops-addon-detail__timeline-value">{{ addon.last_run_at|date:"F d, Y H:i:s" }}</div>
                            </div>
                        </div>
                        {% endif %}

                        {% if addon.last_success_at %}
                        <div class="webops-addon-detail__timeline-item">
                            <span class="material-icons webops-addon-detail__timeline-icon webops-addon-detail__timeline-icon--success">check_circle</span>
                            <div class="webops-addon-detail__timeline-content">
                                <div class="webops-addon-detail__timeline-label">Last Success</div>
                                <div class="webops-addon-detail__timeline-value">{{ addon.last_success_at|date:"F d, Y H:i:s" }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Metadata Card -->
            <div class="webops-addon-detail__card">
                <div class="webops-addon-detail__card-header">
                    <div class="webops-addon-detail__card-header-content">
                        <span class="material-icons">info</span>
                        <h3 class="webops-addon-detail__card-title">Metadata</h3>
                    </div>
                </div>
                <div class="webops-addon-detail__card-body">
                    <div class="webops-addon-detail__metadata-list">
                        <div class="webops-addon-detail__metadata-item">
                            <span class="webops-addon-detail__metadata-label">Name</span>
                            <code class="webops-addon-detail__metadata-value">{{ addon.name }}</code>
                        </div>
                        <div class="webops-addon-detail__metadata-item">
                            <span class="webops-addon-detail__metadata-label">Version</span>
                            <code class="webops-addon-detail__metadata-value">{{ addon.version }}</code>
                        </div>
                        {% if addon.author %}
                        <div class="webops-addon-detail__metadata-item">
                            <span class="webops-addon-detail__metadata-label">Author</span>
                            <span class="webops-addon-detail__metadata-value">{{ addon.author }}</span>
                        </div>
                        {% endif %}
                        <div class="webops-addon-detail__metadata-item">
                            <span class="webops-addon-detail__metadata-label">Status</span>
                            <span class="webops-addon-detail__metadata-value">
                                {% if addon.enabled %}
                                    <span style="color: var(--webops-color-success);">Active</span>
                                {% else %}
                                    <span style="color: var(--webops-color-error);">Inactive</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

                {% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set the width of success rate fill bars based on data-width attribute
    const successRateFills = document.querySelectorAll('.webops-addon-detail__success-rate-fill');
    successRateFills.forEach(function(fill) {
        const width = fill.getAttribute('data-width');
        if (width) {
            fill.style.width = width + '%';
        }
    });
});
</script>

<!-- Load test script (only in development) -->
{% if debug %}
<script src="{% static 'js/addon-detail-test.js' %}"></script>
{% endif %}
